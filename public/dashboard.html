<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RHS | Dashboard</title>
  <link rel="stylesheet" href="CSS/dashboard.css" />
  <script src="./JS/sessao.js"></script>
  <link rel="shortcut icon" href="../public/IMG/icone.ico" type="image/x-icon" />

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body onload="obterDadosGraficoBar(), validarSessao(), listar(), obterDadosGrafico2()">
  <!--  inicio do menu da dashboard  -->

  <div class="menu">
    <h1>Cubix</h1>
    <div class="div_fotouser">
      <img
        id="img-foto"
        src="IMG/Dashboard/adicionar-usuario (1).png"
        alt=""
      />
    </div>
    <div class="hello">
      <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
      <br />
    </div>

    <span id="menu-separacao">Menu</span>
    <div class="separacao"></div>

    <div class="btn-navbar">
      <div class="flexNavBar">
        <a class="outrasPaginas" href="./index.html">
          <img src="IMG/Dashboard/configuracoes.png" alt="" />
          Início
        </a>
      
        <a class="outrasPaginas" href="dashboard.html">
          <img src="IMG/Dashboard/painel-de-controle-verde.png" alt="" />
          Gráficos
        </a>


     
        <a class="outrasPaginas" href="./ComoMontar.html"  >
          <img src="IMG/Dashboard/sino.png" alt="" />
          Monte Novamente
        </a>
      

      
      
        <a class="btn-logout" href="index.html">SAIR DA CONTA</a>

    </div>
  </div>
  </div>
  <!-- fim do menu da dashboard -->

  <div class="dash">
    <div id="graf1" class="div_graficos">
      <div class="graficoBar">
        <span>Pessoas com nivel de dúvida alto (1 e 2)</span>
        <canvas id="qtdDuvidasAltas"></canvas>
      </div>
      <div id="graf???" class="div_grafico">
        <span>Pessoas com nivel de dúvida médio (3 e 4)</span>
        <canvas id="qtdDuvidasBaixas"></canvas>
      </div>
    </div>
    <section class="section_KPIs">

      <div class="div_KPIs">
        <div class="div_KPI" id="KPI1">
          <span class="spanTitulo1"> Vezes que concluído o passo a passo</span>
          <div class="div_KPI1content">
            <span class="spanPorcentagemKPI1">10</span>
          </div>
        </div>
        <div id="KPI2habi" class="KPIhabi" style="display: none;">
          <span class="spanTitulo2" style="height: 100px">Tempetatura e Luminosidade atual</span>
          <div class="div_KPI2content">
            <span class="spanPorcentagemKPI2">18ºC e 702 Lux </span>
            <div class="divTextoKPI2">
            </div>
          </div>
        </div>
        <div class="div_KPI" id="KPI2">
          <span class="spanTitulo2"> Total de passos sem dúvida</span>
          <div class="div_KPI2content">
            <span class="spanSemDuvidaContent">5</span>
            <div class="divTextoKPI2">
            </div>
          </div>
        </div>
        <div class="div_KPI" id="KPI3"><span class="spanTitulo3">Total de passos com dúvida</span>
          <div class="div_KPI3content">
            <div class="divTextoKPI3">
              <div id="span_media_temp" class="spanComDuvidaContent">6</div>
            </div>
          </div>
        </div>
        <div class="div_KPI" id="KPI4">
          <span class="spanTitulo4">Porcentagem de dúvida por conclusão do passo</span>
          <div class="div_KPI4content">
            <div class="divTextoKPI4">
              <span id="span_media_lumi" class="qtdPorcentagemDuvida">4/8</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    <div class="tabelaRanking"><!-- Define uma tabela -->
      <div id="tabelaRanking" class="tabela">
       
          <div class="cabecalho">
              <div class="cabecalho-item">Posição</div>
              <div class="cabecalho-item">Usuário</div>
              <div class="cabecalho-item">Tutorial Finalizado</div>
             
          </div>
          <!--Para barra de rolagem-->
          <div class="corpo-scroll">
              <div id="corpoTabela" class="corpo"></div>
          </div>
      </div>
  </div>
  </div>
</body>
<script>
  d_usuario = sessionStorage.NOME_USUARIO
  var email_id = sessionStorage.EMAIL_USUARIO;
  const ranking = [];
    function listar() {
        fetch("/medidas/ranking", {
            method: "GET",
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error('Erro ao recuperar o ranking');
                }
                return resposta.json();
            })
            .then((ranking) => {
                console.log('Dados do ranking recebidos com sucesso:', ranking);
                preencherRanking(ranking);
            })
            .catch(function (erro) {
                console.error(`#ERRO: ${erro.message}`);
            });
    }
    // função para preencher o ranking
    function preencherRanking(ranking) {
        //reordena do maior para o menor (sort() = ornagina os elementos do arraw conforme a função dada)
        ranking.sort((a, b) => b.pontuacao - a.pontuacao);

        const corpoTabela = document.getElementById('corpoTabela');
        corpoTabela.innerHTML = '';

        //forEach() é usado para iterar sobre cada entrada no ranking ordenado
        ranking.forEach((resultado, indice) => {
            const valorLinha = document.createElement('div');
            valorLinha.classList.add('linha');
            valorLinha.innerHTML = `
            <div class="placar">${indice + 1}º</div>
            <div class="placar">${resultado.usuario}</div>
            <div class="placar">${resultado.pontuacao} pontos</div>
      
        `;
            corpoTabela.innerHTML += valorLinha.outerHTML;
        });
    }

  function obterDadosGraficoBar() {

    
    
    
    var idUser = sessionStorage.ID_USUARIO;
    console.log(idUser)
    fetch("/passos/graficoBar", { method: "GET"
  })
  
  
  .then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then(json => {
          let vetorPassos = [
            Number(json.passo1),
            Number(json.passo2),
            Number(json.passo3),
            Number(json.passo4),
            Number(json.passo5),
            Number(json.passo6),
            Number(json.passo7),
            Number(json.passo8),
            (json.usuarioFk == idUser)
          ]
              
                console.log(resposta );
                
                plotarGrafico(vetorPassos);
              ;})
      } else {

        console.log("Houve um erro ao tentar realizar o login!");
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;

  
} 
  

  function plotarGrafico(vetorPassos){
    let dados = {
      labels : ['passo1',"passo2","passo3","passo4","passo5","passo6","passo7","passo8"],
      datasets: [{
        label: 'qtd de pessoas',
        data: vetorPassos,
        // fill: false,
        backgroundColor: 
          '#fd2828'
        ,
        borderColor: '#fd2828',
        tension: 0.1
      }]
    };


    const config = {
            type: 'bar',
            data: dados,
            responsive: true,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        // position: 'right',

                            fontColor: '#000' // Cor do texto dos rótulos da legenda
        
                    },
                }
            },
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`qtdDuvidasAltas`),
            config
        );
      
  }



  function obterDadosGrafico2() {
    var idUser2 = sessionStorage.ID_USUARIO;

    fetch("/passos/graficoLine", { cache: 'no-store' })
    .then(function (resposta) {
      if (resposta.ok) {
        

        resposta.json().then(json => {
          
                 let vetorPassos2 = [
                Number(json.passo1), 
                Number(json.passo2),
                Number(json.passo3),
                Number(json.passo4),
                Number(json.passo5),
                Number(json.passo6),
                Number(json.passo7),
                Number(json.passo8),
                (json.usuarioFk == idUser2)
                ]
              
             
                
                console.log(resposta );
                
                plotarGraficoBar(vetorPassos2);
              });
      } else {

        console.log("Houve um erro ao tentar realizar o login!");
      }

    }).catch(function (erro) {
      console.log(erro);
    })

    return false;


} 
  

  function plotarGraficoBar(vetorPassos2){
    let dados = {
      labels : ['passo1',"passo2","passo3","passo4","passo5","passo6","passo7","passo8"],
      datasets: [{
        label: 'qtd de pessoas',
        data: vetorPassos2,
        fill: false,
        backgroundColor: 
          '#000'
        ,
        borderColor: '#000',
        tension: 0.1
      }]
    };


    const config = {
            type: 'line',
            data: dados,
            responsive: true,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        // position: 'right',
                            
                          fontColor: 'black' // Cor do texto dos rótulos da legenda
        
                    },
                    
                }
            },
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`qtdDuvidasBaixas`),
            config
        );
      
  }





  
  function atualizarGrafico(dados, qtdDuvidasAltas, qtdDuvidasBaixas) {

fetch(`/medidas/tempo-real`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            


            if (novoRegistro[0].faixa == dados.labels[dados.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].faixa)
                console.log("Horário do último dado capturado:")
                console.log(dados.labels[dados.labels.length - 1])
                console.log("---------------------------------------------------------------")
            } else {
                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro[0].faixa); // incluir um novo momento

                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                dados.datasets[0].data.push(novoRegistro[0].total_usuarios); // incluir uma nova medida de umidade

             

                myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico( dados, graf1), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, qtdDuvidasAltas, qtdDuvidasBaixas), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}


</script>

</html>